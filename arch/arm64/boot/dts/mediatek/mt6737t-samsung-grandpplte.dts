// SPDX-License-Identifier: BSD-3-Clause
/*
 * Copyright (c) 2021, Yassine Oudjana <y.oudjana@protonmail.com>
 */

/dts-v1/;

#include "mt6735.dtsi"
#include "mt6328.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/pinctrl/mediatek,mt6735-pinctrl.h>

/ {
	model = "Samsung Galaxy Grand Prime+";
	compatible = "samsung,grandpplte",
		     "mediatek,mt6737t",
		     "mediatek,mt6735";

	aliases {
		serial0 = &uart0;
	};

	chosen {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		stdout-path = "serial0:115200n8";

		framebuffer: framebuffer@7f900000 {
			compatible = "simple-framebuffer";
			reg = <0 0x7f900000 0 ((540 + 4) * 960 * 4)>;
			width = <540>;
			height = <960>;
			/* Lines have 4 pixels of padding at the end */
			stride = <((540 + 4) * 4)>;
			format = "a8r8g8b8";
		};
	};

	memory@40000000 {
		device_type = "memory";
		reg = <0 0x40000000 0 0x5f530000>;
	};

	reserved-memory {
		ramoops@43f10000 {
			compatible = "ramoops";
			reg = <0 0x43f10000 0 0xe0000>;
		};

		/*
		 * Bootloader-configured framebuffer has 3 layers,
		 * the first of which is used by simple-framebuffer.
		 */
		fb_mem: memory@7f900000 {
			reg = <0 0x7f900000 0 (((540 + 4) * 960 * 4) * 3)>;
			no-map;
		};
	};

	vdd_tflash: regulator-vdd-tflash {
		compatible = "regulator-fixed";
		regulator-name = "vdd_tflash";
		regulator-min-microvolt = <3000000>;
		regulator-max-microvolt = <3000000>;
		regulator-allow-set-load;
		startup-delay-us = <100>;
		gpio = <&pio 19 0>;
		enable-active-high;

		pinctrl-names = "default";
		pinctrl-0 = <&vdd_tflash_default>;
	};

	/*
	 * Until hardware I2C is supported, bit-banged I2C using the
	 * I2C3 SDA/SCL pins as GPIOs can be used to communicate with
	 * the touchscreen.
	 */
	 i2c-3 {
		compatible = "i2c-gpio";

		sda-gpios = <&pio 53 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;
		scl-gpios = <&pio 54 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN)>;

		pinctrl-names = "default";
		pinctrl-0 = <&i2c3_default>;

		#address-cells = <1>;
		#size-cells = <0>;

		touchscreen@20 {
			compatible = "zinitix,bt541";
			reg = <0x20>;
			interrupt-parent = <&pio>;
			interrupts = <62 IRQ_TYPE_EDGE_FALLING>;

			touchscreen-size-x = <539>;
			touchscreen-size-y = <959>;
		};
	};
};

/* Touchscreen supply. TODO: Add regulator handling to zinitix driver */
&mt6328_vgp1_reg {
	regulator-always-on;
};

&mt6328_keys {
	status = "okay";

	power-off-time-sec = <10>;
};

&mt6328_home {
	linux,keycodes = <KEY_VOLUMEDOWN>;
};

&pio {
	vdd_tflash_default: vdd-tflash-default-pins {
		pins-ce {
			pinmux = <PINMUX_GPIO19__FUNC_GPIO19>;
		};
	};

	i2c3_default: i2c3_default-pins {
		pins-sda-scl {
			pinmux = <PINMUX_GPIO53__FUNC_GPIO53>,
				 <PINMUX_GPIO54__FUNC_GPIO54>;
		};
	};
};

&pwrap {
	status = "okay";
};

&mmc0 {
	status = "okay";

	vmmc-supply = <&mt6328_vemc33_reg>;
	vqmmc-supply = <&mt6328_vio18_reg>;

	bus-width = <8>;
	max-frequency = <20000000>;
	cap-mmc-highspeed;
	mmc-ddr-1_8v;
	mmc-hs200-1_8v;
	/* TODO: Fix tuning issue in HS400 mode */
	// mmc-hs400-1_8v;
	non-removable;

	mediatek,hs200-cmd-int-delay = <11>;
	mediatek,hs400-cmd-int-delay = <6>;
	mediatek,hs400-cmd-resp-sel-rising;
	mediatek,hs400-ds-dly3 = <10>;
	mediatek,latch-ck = <1>;
};

/* TODO: Fix microSD card slot. Possibly a power issue. */
&mmc1 {
	status = "okay";

	vmmc-supply = <&vdd_tflash>;
	vqmmc-supply = <&vdd_tflash>;

	bus-width = <4>;
	max-frequency = <20000000>;
	cap-sd-highspeed;
	sd-uhs-sdr12;
	sd-uhs-sdr25;
	sd-uhs-sdr50;
	sd-uhs-sdr104;
	sd-uhs-ddr50;

	cd-gpios = <&pio 5 GPIO_ACTIVE_LOW>;
};

/*
 * UART accessible through USB micro-B port with 619k resistor
 * connected between ID and GND. TX on D+, RX on D-.
 */
&uart0 {
	status = "okay";
};

&usb2 {
	status = "okay";

	usb_con: connector {
		compatible = "usb-b-connector";
		type = "micro";
	};
};

&usb2phy {
	status = "okay";
};
